<!DOCTYPE html>
<!-- V5e.html is generated by V5e.py, so don't EDIT it -->

<head>
  <title>Vampire the Masquerade 5th Edition</title>
  <link rel="stylesheet" type="text/css" href="V5e.css">
</head>

<body>

<div class="sheet-page">

  <!-- Title -->
  <div style="display: inline-block;">
    <h1>Vampire the Masquerade</h1>
    <h4>5th Edition</h4>
  </div>
  <br />

  <!-- Basics -->
  <div class="sheet-divrow" style="display: inline-block;">
    <h2 style="display: inline-block;">Basics</h2>
    <input title="hide" name="attr_basics_switch" style="width: 1em;display: inline-block;" type="checkbox" class="sheet-block-switch"/>
    <br />
    <div class="sheet-block-a">
      <div class="sheet-divcol">
        <table>
          <tr>
            <th style="width: 7em">Name:</th><td><input class="prop_val" title="name" type="text" name="attr_name"/></td></tr>
          <tr>
            <th style="width: 7em">Chronicle:</th><td><input class="prop_val" title="chronicle" type="text" name="attr_chronicle"/></td></tr>
          <tr>
            <th style="width: 7em">Sire:</th><td><input class="prop_val" title="sire" type="text" name="attr_sire"/></td></tr>
        </table>
      </div>
      <div class="sheet-divcol">
        <table>
          <tr>
            <th style="width: 7em">Concept:</th><td><input class="prop_val" title="concept" type="text" name="attr_concept"/></td></tr>
          <tr>
            <th style="width: 7em">Ambition:</th><td><input class="prop_val" title="ambition" type="text" name="attr_ambition"/></td></tr>
          <tr>
            <th style="width: 7em">Desire:</th><td><input class="prop_val" title="desire" type="text" name="attr_desire"/></td></tr>
        </table>
      </div>
      <div class="sheet-divcol">
        <table>
          <tr>
            <th style="width: 7em">Predator:</th><td><input class="prop_val" title="predator" type="text" name="attr_predator"/></td></tr>
          <tr>
            <th style="width: 7em">Clan:</th><td><select name="attr_clan" style="width: 15em"><option value="brujah">brujah</option><option value="gangrel">gangrel</option><option value="malkavian">malkavian</option><option value="nosferatu">nosferatu</option><option value="ravnos">ravnos</option><option value="toreador">toreador</option><option value="tremere">tremere</option><option value="ventrue">ventrue</option><option value="lasombra">lasombra</option><option value="thin-blood">thin-blood</option><option value="caitiff">caitiff</option><option value="human">human</option><option value="animal">animal</option><option value="werewolf">werewolf</option><option value="mage">mage</option><option value="faerie">faerie</option><option value="ghost">ghost</option><option value="demon">demon</option></select></td></tr>
          <tr>
            <th style="width: 7em">Generation:</th><td><input class="prop_val" title="generation" type="text" name="attr_generation"/></td></tr>
        </table>
      </div>
    </div>
    <div class="sheet-block-b">
    </div>
  </div>

  <!-- Stats -->
  <div class="sheet-divrow">
    <h2 style="display: inline-block;">Stats</h2>
    <input title="hide" name="attr_stats_switch" style="width: 1em;display: inline-block;" type="checkbox" class="sheet-block-switch"/>
    <br />
    <div class="sheet-block-a">
      <div class="sheet-divcol">
        <h3>Misc</h3>
        <table >
          <input name="attr_total_xp" value="0" type="hidden"/>
          <tr>
            <th>Xp</th>
            <td><input name="attr_total_xp_disp" value="@{total_xp}" title="xp spent" type="number" disabled="true"/></td>
            <td>/</td>
            <td><input name="attr_xp_avail" value="0" title="xp available" type="number"/></td>
          </tr>
          <tr>
            <th>Hunger</th>
            <td><input name="attr_hunger" value="0" title="hunger" type="number"/></td>
            <td>/</td>
            <td><input name="attr_hunger_max" value="5" title="hunger max" type="number" disabled="true"/></td>
          </tr>
          <tr>
            <th>Humanity</th>
            <td><input name="attr_humanity" value="0" title="humanity" type="number"/></td>
            <td>/</td>
            <td><input name="attr_humanity_max" value="10" title="humanity max" type="number" disabled="true"/></td>
          </tr>
        </table>
      </div>
      <div class="sheet-divcol">
        <h3>Health</h3>
        <div style="width: 9em; display:inline-block;">
          <table>
            
            <tr>
              <th>Superficial</th>
              <td><input name="attr_dmg_superficial" value="0" min="0" title="superficial damage" type="number"/></td>
            </tr>
            
            <tr>
              <th>Aggravated</th>
              <td><input name="attr_dmg_aggravated" value="0" min="0" title="aggravated damage" type="number"/></td>
            </tr>
            
            <tr>
              <th>Level</th>
              <input name="attr_health" value="0" type="hidden"/>
              <td><input name="attr_health_disp" value="@{health}" title="health" type="number" disabled="true"/></td>
              <td>/</td>
              <td><input name="attr_health_max" value="7" min="0" title="health max" type="number"/></td>
              <input name="attr_health_total" value="0" type="hidden"/>
              <input name="attr_health_total_max" value="0" type="hidden"/>
            </tr>
            <tr>
              <th>State</th>
              <input name="attr_health_state" value="OK" type="hidden"/>
              <td colspan="3"><input name="attr_health_state_disp" value="@{health_state}" title="health state" type="text" disabled="true"/></td>
            </tr>
          </table>
        </div>
      </div>
      <div class="sheet-divcol">
        <h3>Willpower</h3>
        <div style="width: 9em; display:inline-block;">
          <table>
            
            <tr>
              <th>Superficial</th>
              <td><input name="attr_will_superficial" value="0" min="0" title="superficial damage" type="number"/></td>
            </tr>
            
            <tr>
              <th>Aggravated</th>
              <td><input name="attr_will_aggravated" value="0" min="0" title="aggravated damage" type="number"/></td>
            </tr>
            
            <tr>
              <th>Level</th>
              <input name="attr_health" value="0" type="hidden"/>
              <td><input name="attr_will_disp" value="@{will}" title="will" type="number" disabled="true"/></td>
              <td>/</td>
              <td><input name="attr_will_max" value="7" min="0" title="will max" type="number"/></td>
              <input name="attr_will_total" value="0" type="hidden"/>
              <input name="attr_will_total_max" value="0" type="hidden"/>
            </tr>
            <tr>
              <th>State</th>
              <input name="attr_will_state" value="OK" type="hidden"/>
              <td colspan="3"><input name="attr_will_state_disp" value="@{will_state}" title="will state" type="text" disabled="true"/></td>
            </tr>
          </table>
        </div>
      </div>
    </div>
    <div class="sheet-block-b">
    </div>
  </div>

  <!-- Character Sheet Sections -->

  <!-- Notes -->
  <div class="sheet-divrow">
    <h2 style="display: inline-block;">Notes</h2>
    <input title="hide" name="attr_basics_switch" style="width: max;display: inline-block;" type="checkbox" class="sheet-block-switch"/>
    <br />
    <div class="sheet-block-a">
      <div class="sheet-divcol">
        <h3>Description</h3>
        <div class="sheet-block-a">
          <textarea name="attr_description" rows="30" cols="38"></textarea>
        </div>
        <div class="sheet-block-b">
        </div>
      </div>
      <div class="sheet-divcol">
        <h3>Possessions</h3>
        <div class="sheet-block-a">
          <textarea name="attr_possessions" rows="30" cols="38"></textarea>
        </div>
        <div class="sheet-block-b">
        </div>
      </div>
      <div class="sheet-divcol">
        <h3>Journal</h3>
        <div class="sheet-block-a">
          <textarea name="attr_history" rows="30" cols="38"></textarea>
        </div>
        <div class="sheet-block-b">
        </div>
      </div>
    </div>
    <div class="sheet-block-b">
    </div>
  </div>
</div>

<script type="text/worker">
const data = JSON.parse('{"title":"Vampire the Masquerade","subtitle":"5th Edition","header":{"col1":{"fields":{"name":{},"chronicle":{},"sire":{}}},"col2":{"fields":{"concept":{},"ambition":{},"desire":{}}},"col3":{"fields":{"predator":{},"clan":{},"generation":{}}}},"sections":{"mult_xp_cost":0,"new_xp_cost":0,"val_start":0,"val_min":0,"val_max":5,"initial_base":0,"nameable":false,"specialty":false,"field_type":"bar"},"clan":{"brujah":{"disciplines":["celerity","potence","presence"]},"gangrel":{"disciplines":["animalism","fortitude","protean"]},"malkavian":{"disciplines":["auspex","dominate","obfuscate"]},"nosferatu":{"disciplines":["animalism","obfuscate","potence"]},"ravnos":{"disciplines":["animalism","chimerstry","fortitude"]},"toreador":{"disciplines":["auspex","celerity","presence"]},"tremere":{"disciplines":["auspex","dominate","blood_sorcery"]},"ventrue":{"disciplines":["dominate","fortitude","presence"]},"lasombra":{"disciplines":["dominate","potence","oblivion"]},"thin-blood":{"disciplines":["thin-blood-alchemy"]},"caitiff":{"disciplines":[]},"human":{"disciplines":[]},"animal":{"disciplines":[]},"werewolf":{"disciplines":["celerity","potence","protean"]},"mage":{"disciplines":["auspex","dominate","fortitude","presence","blood_sorcery"]},"faerie":{"disciplines":["animalism","auspex","celerity","obfuscate","protean"]},"ghost":{"disciplines":["auspex","dominate","presence"]},"demon":{"disciplines":["dominate","potence","fortitude"]}},"generation_table":{"hdr":["trait_max","blood_pool_max","blood_per_turn"],"3":[10,100,20],"4":[9,50,10],"5":[8,40,8],"6":[7,30,6],"7":[6,20,4],"8":[5,15,3],"9":[5,14,2],"10":[5,13,1],"11":[5,12,1],"12":[5,11,1],"13":[5,10,1]},"hunger":{"5":{"state":"Torpor","penalty":0}},"health":{"0":{"state":"Impaired","penalty":-2}},"will":{"0":{"state":"Impaired","penalty":-2}},"postfixes":["base","xp"]}');
"use strict";
console.log(data);

// change arg lists
function list_changed(l) {
  var out = l.map(x => "change:" + x).join(" ");
  return out;
}

function xpCost(k, b, xp) {
  var cost = 0;
  var i = b
  while (i < b + xp) {
    i += 1
    cost += k*i
  }
  return cost;
}

function attach_field_sum(name, fields, postfix) {
  var deps = Object.keys(fields).map(x => x + "_" + postfix);
  on(list_changed(deps), function(eventInfo) {
    console.log(name, postfix, "deps changed");
    getAttrs(deps, function(v) {
      var d = {};
      var cost = 0;
      for (field in fields) {
        var val = parseInt(v[field + "_" + postfix], 10);
        if (isNaN(val)) {
          console.log(field + "_" + postfix, " is NaN");
        } else {
          cost += val;
        }
      }
      d[name + "_" + postfix] = cost;
      setAttrs(d);
      console.log(d);
    });
  });
}

function attach_property(name) {
  //console.log("attaching property " + name);
  var tot_deps = [
    name + "_base",
    name + "_xp"
  ];
  var radio_deps = [
    name + "_radio",
    name
  ];

  // update total if deps change
  on(list_changed(tot_deps) + " sheet:opened", function() {
    console.log(name + " total deps changed");
    getAttrs(tot_deps, function(v) {
      set_d = {};
      var b = parseInt(v[name + "_base"], 10);
      var xp = parseInt(v[name + "_xp"], 10);
      var tot = b + xp;
      console.log("updating total for " + name + ", b:", b, " xp:", xp)
      set_d[name] = tot;
      setAttrs(set_d);
    });
  });

  // update xp, base if radio changes
  on("change:" + name + "_radio", function() {
    console.log(name + " radio changed");
    getAttrs([].concat(radio_deps, tot_deps), function(v) {
      set_d = {};
      var b = parseInt(v[name + "_base"], 10);
      var xp = parseInt(v[name + "_xp"], 10);
      var radio = parseInt(v[name + "_radio"], 10);
      console.log("updating total for " + name + " b:", b, " radio:", radio);
      if (radio < b) {
        b = radio;
        xp = 0;
      } else {
        xp = radio - b;
      }
      set_d[name + "_base"] = b;
      set_d[name + "_xp"] = xp;
      setAttrs(set_d);
    });
  });

  // update radio if total changes
  on("change:" + name, function() {
    console.log(name + " total changed");
    getAttrs([].concat(radio_deps, tot_deps), function(v) {
      set_d = {};
      var tot = parseInt(v[name], 10);
      console.log("updating radio for " + name + " tot:", tot);
      set_d[name + "_radio"] = tot;
      setAttrs(set_d);
    });
  });
}

function attach_type_bar(key_type, type, data) {
  console.log("attaching type", key_type);

  // handle no field case
  if (type.fields === undefined) {
    type.fields = {};
  }

  // properties
  for (var key_prop in type.fields) {
    attach_property(key_prop);
  }

  // base
  var base_deps = Object.keys(type.fields).map(x => x + '_base');
  on(list_changed(base_deps), function() {
    console.log("base_" + key_type + " deps changed");
    getAttrs(base_deps, function(v) {
      var d = {};
      var base = 0;
      for (i in base_deps) {
        base += parseInt(v[base_deps[i]], 10);
      }
      base -= Object.keys(type.fields).length*type.initial_base;
      d[key_type + "_base"] = base;
      setAttrs(d);
      console.log(d);
    });
  });

  // xp
  var xp_deps = [].concat(...Object.keys(type.fields).map(x => [x + "_xp", x + "_base", "clan"]));
  on(list_changed(xp_deps), function() {
    console.log(key_type + " xp deps changed");
    getAttrs(xp_deps, function(v) {
      var d = {};
      var cost = 0;
      for (name in type.fields) {
        var b = parseInt(v[name + "_base"], 10);
        var xp = parseInt(v[name + "_xp"], 10);
        var mult_xp_cost = type.mult_xp_cost;
        if (key_type === "disciplines") {
          var clan = v["clan"];
          if (clan === "caitiff") {
            mult_xp_cost = type.mult_xp_cost_caitiff;
            console.log("caitiff discipline");
          } else if (data.clan[clan].disciplines.indexOf(name) > -1) {
            mult_xp_cost = type.mult_xp_cost_clan;
            console.log(name, "is a ", clan, "disciplines");
          } else {
            console.log(name, "is not a", clan, "disciplines");
          }
        }
        cost += xpCost(mult_xp_cost, b, xp);
      }
      d[key_type + "_xp"] = cost;
      setAttrs(d);
      console.log(d);
    });
  });
}

function attach_section(name, section, data) {
  console.log("attaching section", name);

  // handle no field case
  if (section.fields === undefined) {
    section.fields = {};
  }

  for (var key_type in section.fields) {
    var type = section.fields[key_type];
    if (type.field_type === "bar") {
      attach_type_bar(key_type, type, data);
    }
  }

  // update field sums
  attach_field_sum(name, section.fields, "xp");
}

function attach_health(data) {
  var health_deps = ["health_max", "dmg_superficial", "dmg_aggravated"];
  on(list_changed(health_deps), function(eventInfo) {
    console.log("damage changed");
    getAttrs(health_deps, function(v) {
      var dmg = {
        sup: parseInt(v["dmg_superficial"], 10),
        aggr: parseInt(v["dmg_aggravated"], 10)
      };
      var health_max = parseInt(v["health_max"], 10);
      for (key in dmg) {
        if (dmg[key] < 0) {
          dmg[key] = 0;
        }
      }

      var count = 0;
      while (dmg["sup"] + dmg["aggr"] > health_max) {
        if (dmg["sup"] > 1) {
          console.log("carrying superficial damage to aggravated");
          dmg["sup"] -= 2;
          dmg["aggr"] += 1;
        } else if (dmg["aggr"] > 0) {
          console.log("max damage reached");
          dmg["sup"] = 0;
          dmg["aggr"] = health_max;
        }
        // safeguard for infinite loop
        if (count++ > 100) {
          console.error("exceeded maximum loop count in health update");
          break;
        }
      }
      var health = health_max - (dmg["sup"] + dmg["aggr"]);
      var health_total_max = 2*health_max;
      var health_total = health_total_max - (dmg["sup"] + 2*dmg["aggr"]);
      var penalty = 0;
      var health_state = "OK";
      if (data["health"][health] != undefined) {
        penalty = data["health"][health]["penalty"];
        health_state = data["health"][health]["state"];
      }
      setAttrs({
        dmg_superficial: dmg["sup"],
        dmg_aggravated: dmg["aggr"],
        health: health,
        health_total: health_total,
        health_total_max: health_total_max,
        wound_penalty: penalty,
        health_state: health_state
      });
    });
  });
}

function attach_will(data) {
  var will_deps = ["will_max", "will_superficial", "will_aggravated"];
  on(list_changed(will_deps), function(eventInfo) {
    console.log("will changed");
    getAttrs(will_deps, function(v) {
      var dmg = {
        sup: parseInt(v["will_superficial"], 10),
        aggr: parseInt(v["will_aggravated"], 10)
      };
      var will_max = parseInt(v["will_max"], 10);
      for (key in dmg) {
        if (dmg[key] < 0) {
          dmg[key] = 0;
        }
      }

      var count = 0;
      while (dmg["sup"] + dmg["aggr"] > will_max) {
        if (dmg["sup"] > 1) {
          console.log("carrying superficial damage to aggravated");
          dmg["sup"] -= 2;
          dmg["aggr"] += 1;
        } else if (dmg["aggr"] > 0) {
          console.log("max damage reached");
          dmg["sup"] = 0;
          dmg["aggr"] = will_max;
        }
        // safeguard for infinite loop
        if (count++ > 100) {
          console.error("exceeded maximum loop count in will update");
          break;
        }
      }
      var will = will_max - (dmg["sup"] + dmg["aggr"]);
      var penalty = 0;
      var will_state = "OK";
      if (data["will"][will] != undefined) {
        penalty = data["will"][will]["penalty"];
        will_state = data["will"][will]["state"];
      }
      var will_total_max = 2*will_max;
      var will_total = will_total_max - (dmg["sup"] + 2*dmg["aggr"]);
      setAttrs({
        will_superficial: dmg["sup"],
        will_aggravated: dmg["aggr"],
        will: will,
        will_total: will_total,
        will_total_max: will_total_max,
        will_penalty: penalty,
        will_state: will_state
      });
    });
  });
}



function attach_data(data) {
  console.log("attaching data");

  if (data.sections.fields === undefined) {
    data.sections.fields = {};
  }

  for (var key_sect in data.sections.fields) {
    var sect = data.sections.fields[key_sect];
    attach_section(key_sect, sect, data);
  }

  // attach field sums
  attach_field_sum("total", data.sections.fields, "xp");

  // attach health
  attach_health(data);

  // attach will
  attach_will(data);
}

attach_data(data);

on("sheet:opened", function() {
  console.log("sheet opened");
});


// vim: set et fenc=utf-8 ff=unix ft=javascript sts=0 sw=2 ts=2 :

</script>


<rolltemplate class="sheet-rolltemplate-wod">
  <table>
    <tbody>
      <tr>
        <th>{{name}}</th>
      </tr>
      <td style="height: 2px; text-align: center; width: 200px " valign="middle ">
        <hr style="border-top:2px solid rgb(112, 0, 0); " noshade>
      </td>

      {{#Rollname}}
      <tr>
        <td class="attr " style="font-size: 1.1em; ">{{Rollname}}</td>
      </tr>
      <td style="height: 2px; text-align: center; width: 200px " valign="middle ">
        <hr style="border-top:1px solid rgb(112, 0, 0); " noshade>
      </td>
      {{/Rollname}} {{#Roll}}
      <tr>
        <td class="attr ">Roll</td>
      </tr>
      <td style="height: 2px; text-align: center; width: 200px " valign="middle ">
        <hr style="border-top:1px solid rgb(112, 0, 0); " noshade>
      </td>
      <tr>
        <td class="attr " style="padding-bottom: 8px; ">{{Roll}}</td>
      </tr>
      {{/Roll}} {{#DisciplineDetails}}
      <tr>
        <td class="attr " style="padding-bottom: 8px; ">{{DisciplineDetails}}</td>
      </tr>
      {{/DisciplineDetails}}{{#Normal}}
      <tr>
        <td class="attr ">Normal</td>
      </tr>
      <td style="height: 2px; text-align: center; width: 200px " valign="middle ">
        <hr style="border-top:1px solid rgb(112, 0, 0); " noshade>
      </td>
      <tr>
        <td class="attr " style="padding-bottom: 8px; ">{{Normal}}</td>
      </tr>
      {{/Normal}} {{#NormalSuccesses}}
      <tr>
        <td class="attr ">Normal Successes</td>
      </tr>
      {{#NormalDice}}
      <tr>
        <td class="attr ">(Dice rolled: {{NormalDice}})</td>
      </tr>
      {{/NormalDice}}
      <td style="height: 2px; text-align: center; width: 200px " valign="middle ">
        <hr style="border-top:1px solid rgb(112, 0, 0); " noshade>
      </td>
      <tr>
        <td class="attr " style="padding-bottom: 8px;font-size: 24px; ">{{NormalSuccesses}}</td>
      </tr>
      {{/NormalSuccesses}}{{#Hunger}}
      <tr>
        <td class="attr ">Hunger</td>
      </tr>
      <td style="height: 2px; text-align: center; width: 200px " valign="middle ">
        <hr style="border-top:1px solid rgb(112, 0, 0); " noshade>
      </td>
      <tr>
        <td class="attr " style="padding-bottom: 8px; ">{{Hunger}}</td>
      </tr>
      {{/Hunger}} {{#HungerSuccesses}}
      <tr>
        <td class="attr ">Hunger Successes</td>
      </tr>
      {{#HungerDice}}
      <tr>
        <td class="attr ">(Dice rolled: {{HungerDice}})</td>
      </tr>
      {{/HungerDice}}
      <td style="height: 2px; text-align: center; width: 200px " valign="middle ">
        <hr style="border-top:1px solid rgb(112, 0, 0); " noshade>
      </td>
      <tr>
        <td class="attr " style="font-size: 24px; ">{{HungerSuccesses}}</td>
      </tr>
      {{/HungerSuccesses}}{{#Successes}}
      <tr>
        <td class="attr ">Successes</td>
      </tr>
      <td style="height: 2px; text-align: center; width: 200px " valign="middle ">
        <hr style="border-top:1px solid rgb(112, 0, 0); " noshade>
      </td>
      <tr>
        <td class="attr " style="font-size: 24px; ">{{Successes}}</td>
      </tr>
      {{/Successes}}
      <td style="height: 2px; text-align: center; width: 200px " valign="middle ">
        <hr style="border-top:2px solid rgb(112, 0, 0); " noshade>
      </td>
      <tr>
        <td class="attr ">{{#Miss}}{{Miss}}{{/Miss}}</td>
      </tr>
      <tr>
        <td class="attr ">{{#Crit}}{{Crit}}{{/Crit}}</td>
      </tr>
      <tr>
        <td class="attr ">{{#Messy}}{{Messy}}{{/Messy}}</td>
      </tr>
      <tr>
        <td class="attr ">{{#Beast}}{{Beast}}{{/Beast}}</td>
      </tr>
      <tr>
        <td class="attr " style="font-style: italic; ">{{#BeastTaunt}}{{BeastTaunt}}{{/BeastTaunt}}</td>
      </tr>
      <tr>
        <td class="attr ">{{#Fate}}{{Fate}}{{/Fate}}</td>
      </tr>
      <tr>
        <th style="padding: 15px 2px 0px 20px; "></th>
      </tr>
    </tbody>
  </table>
  {{Reroll}}
</rolltemplate>


</body>

<!-- vim: set et ft=html fenc=utf-8 ff=dos sts=0 sw=4 ts=4 : -->